<!DOCTYPE html>
<html><head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

    <title>Process memory manipulation in OSX - Curiosity Kills Boredom</title>

    
    
    <meta name="description" content="Cool cat for inspiration :) So&hellip; here we go!
So the objective is to read memory from a process and then modify it. Pretty simple right? I will use C&#43;&#43; for this because it offers many of the low level capabilities that we will need to do this but I am sure you can use your preffered language too.
Well&hellip; if we want to read memory from a process then we need to have a process running!" />
    <meta name="author" content="" />
    

    <link href="https://unpkg.com/@master/normal.css" rel="stylesheet">
    <script src="https://unpkg.com/@master/style@1.5.0"></script>
    <script src="https://unpkg.com/@master/styles@1.13.0"></script>
    <script src="https://unpkg.com/master-styles-group"></script>
    <script src="https://unpkg.com/themes.js"></script>
    <script>window.themes = window.themes || new window.Themes()</script>

    <style>
        :root {
            --font-sans: "Inter var", ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica Neue, Arial, Noto Sans, sans-serif, Apple Color Emoji, Segoe UI Emoji, Segoe UI Symbol, Noto Color Emoji;
        }
    </style></head>
<body class="bg:fade-84@dark font:fade-16@dark font:sans">
    <nav class="w:full h:90 fixed bg:fade-84/.95@dark bg:white z:1000">
    <div class="
        h:full
        w:full
        max-w:1200
        mx:auto
        px:32
        d:flex
        align-items:center
    ">
        <div>
            <a href="/" class="mr-3 font:extralight">
              
              Curiosity Kills Boredom
              
            </a>
        </div>

        <div class="ml:auto">
            
            
            
        </div>
    </div>
</nav>
<div class="d:flex flex:column@<=sm pt:90 px:24 jc:center gap:44 word-break:break-word">
        <div class="max-w:700 w:full box:content-box">
<article class="box:border-box pt:32">
    <header class="mb:32">
        <div class="font:40 font:extrabold">Process memory manipulation in OSX</div>
        <div class="mt:16 f:fade-60">
            <time>Nov 5, 2023</time>
            </div>
    </header><div class="
    _:where(a):hover{text-decoration-color:fade}
    _:where(a){text-decoration:2;underline;fade-10;_text-decoration-color:fade-70@dark}
    _:where(blockquote){bl:5;solid;fade-76/.1;_bl:5;solid;fade-34/.1@dark}
    _:where(code){font:90%;_v:middle}
    _:where(code:not(.highlight_*,pre_*)){p:2;6;_r:4}
    _:where(del){text-decoration:1;line-through;fade-68;_text-decoration-color:red-64@dark}
    _:where(figcaption){text:14;_p:10;20;0;_width:fit;_mx:auto;_font:fade-56;_font:fade-57@dark}
    _:where(h1){font:40;_font:extrabold}
    _:where(h1,h2,h3)+:where(h1,h2,h3){mt:.5em}
    _:where(h1,h2,h3,h4,h5,h6){mt:2em}
    _:where(h2){mb:1em;_font:32}
    _:where(h3){font:24}
    _:where(h4){font:20}
    _:where(h5){font:16}
    _:where(h6){font:14}
    _:where(li)::marker{font:fade-44;_font:fade-68@dark}
    _:where(li){pl:.375em}
    _:where(mark){text-decoration:1;underline;#fce016;_bg:transparent;_text-decoration-color:rgb(252;224;22/.5)@dark}
    _:where(p,li){font:fade-76;_font:16;_line-height:1.65;_font:fade-34@dark}
    _:where(p,pre,blockquote,figure,ul,ol,table){my:1.125em}
    >:first-child{mt:0!}
    _:where(pre){p:20;_r:8;_overflow:auto}
    _:where(pre,code:not(.highlight_*)){bg:fade-2;_bg:fade-92!@dark}
    _:where(strong,b,a,code:not(.highlight_*),mark,del){font:fade-92;_font:fade-12@dark}
    _:where(table){width:full;_border-spacing:0}
    _:where(td){v:baseline}
    _:where(td,th):first-child{pl:0}
    _:where(td,th):last-child{pr:0}
    _:where(td,th){bb:1;solid;fade-92/.06;_p:6;_b:fade-4/.04@dark}
    _:where(th){font:fade-78;_font:14;_text:left;_font:fade-12@dark}
    _:where(th,p_code,li_code,a,mark){font:semibold;_font:medium@dark}
    _:where(ul){list-style-type:disc}
    _:where(ul,ol,blockquote){pl:1.5em}
    _:where(video,img){max-width:full}
    _:where(a,mark){text-underline-offset:3}
    _:where(hr){h:2;_bg:fade-10;_bg:fade-70@dark;_my:3em}
"><p>Cool cat for inspiration :)
<img src="/images/test.jpeg" alt="image alt text"></p>
<p>So&hellip; here we go!</p>
<p>So the objective is to read memory from a process and then modify it. Pretty
simple right?
I will use C++ for this because it offers many of the low level capabilities
that we will need to do this but I am sure you can use your preffered language
too.</p>
<p>Well&hellip; if we want to read memory from a process then we need to have a process
running! For this purpose let&rsquo;s create a simple program that will be our target:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;iostream&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e">#include</span> <span style="color:#75715e">&lt;unistd.h&gt;</span><span style="color:#75715e">
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">printString</span>(std<span style="color:#f92672">::</span>string foo){
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> foo <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">addInt</span>(<span style="color:#66d9ef">int</span> foo, <span style="color:#66d9ef">int</span> bar){
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> foo <span style="color:#f92672">+</span> bar;
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printString(<span style="color:#e6db74">&#34;Welcome...&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> foo <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> bar <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Adress of foo: &#34;</span> <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">&amp;</span>foo <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span>(true){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        printString(<span style="color:#e6db74">&#34;Here we go again...&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">int</span> result <span style="color:#f92672">=</span> addInt(foo, bar);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        printString(std<span style="color:#f92672">::</span>to_string(result));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        usleep(<span style="color:#ae81ff">5000000</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>We have to get the process identifier of the process that we
want to read memory from, commonly known as PID.
The easy way in OSX to do this is to go to your Activity Monitor, there you
will find something like this:
<img src="/images/activitymonitor.png" alt="pidactivity"></p>
<p>Now let&rsquo;s find out how to get the PID with c++, we don&rsquo;t want to use the
Activity Monitor for that, we like to program goddamit!</p>
<p>We can use the terminal to list all processes and their Pid using:
ps -A -o pid,comm</p>
<p><img src="/images/pidCommand.png" alt="pscommand"></p>
<p>Hmm&hellip; So we can execute the terminal command in our program and get the
target&rsquo;s pid!</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">getProcessPid</span>(std<span style="color:#f92672">::</span>string processName){
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Run the ps command to list all processes and capture its output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    std<span style="color:#f92672">::</span>string psCommand <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;ps -A -o pid,comm&#34;</span>;
</span></span><span style="display:flex;"><span>    FILE<span style="color:#f92672">*</span> psOutput <span style="color:#f92672">=</span> popen(psCommand.c_str(), <span style="color:#e6db74">&#34;r&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>psOutput) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Error running the ps command.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read and parse the ps command output
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">char</span> line[<span style="color:#ae81ff">256</span>];
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (fgets(line, <span style="color:#66d9ef">sizeof</span>(line), psOutput)) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>string processLine <span style="color:#f92672">=</span> line;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#75715e">// Check if the line contains the process name
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> (processLine.find(processName) <span style="color:#f92672">!=</span> std<span style="color:#f92672">::</span>string<span style="color:#f92672">::</span>npos) {
</span></span><span style="display:flex;"><span>            <span style="color:#75715e">// Extract the PID from the line
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>            <span style="color:#66d9ef">int</span> pid <span style="color:#f92672">=</span> std<span style="color:#f92672">::</span>atoi(processLine.c_str());
</span></span><span style="display:flex;"><span>            pclose(psOutput);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span> pid;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    pclose(psOutput);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Now we need to read the process memory&hellip;
Hopefully I have control over the target, and I am priting it&rsquo;s memory adress.
:)</p>
<p>Now we know it&rsquo;s memory adress we need to know how to read inside this memory
adress and how to write to it.</p>
<p>Searching for OSX internal functions we find mach_vm_read and mach_vm_write.
For mach_vm_read we need to have the target task port so we can have
&ldquo;permissions&rdquo; to read and write memory to the process.
For this we can call task_for_pid, with the pid that we already have this will
return a task port that we will use to have &ldquo;permissions&rdquo; to do mach_vm_read and
mach_vm_write.</p>
<p>The mach_vm_read will read a buffer of memory on the target memory adress specified.
The mach_vm_write will write a buffer of data to the target memory address
specified.</p>
<p>Here is a full implementation below:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c++" data-lang="c++"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>(){
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> targetPID <span style="color:#f92672">=</span> getProcessPid(<span style="color:#e6db74">&#34;testMe&#34;</span>);
</span></span><span style="display:flex;"><span>    
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span>(<span style="color:#f92672">!</span>getProcessPid(<span style="color:#e6db74">&#34;testMe&#34;</span>)) <span style="color:#75715e">//Process not found
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>        <span style="color:#66d9ef">return</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> targetPID <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Create a task port to the target process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    task_t targetTask; <span style="color:#75715e">//https://developer.apple.com/documentation/kernel/task_t
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> (task_for_pid(mach_task_self(), targetPID, <span style="color:#f92672">&amp;</span>targetTask) <span style="color:#f92672">!=</span> KERN_SUCCESS) {
</span></span><span style="display:flex;"><span>        std<span style="color:#f92672">::</span>cerr <span style="color:#f92672">&lt;&lt;</span> <span style="color:#e6db74">&#34;Failed to get task port for the target process.&#34;</span> <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">1</span>;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Address of memory to read of the target process
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mach_vm_address_t address <span style="color:#f92672">=</span> <span style="color:#ae81ff">0x16f73f4c0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Read from the target process&#39;s memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    vm_offset_t buffer <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>    mach_msg_type_number_t bytesRead;
</span></span><span style="display:flex;"><span>    mach_vm_read(targetTask, address, <span style="color:#66d9ef">sizeof</span>(<span style="color:#66d9ef">int</span>), <span style="color:#f92672">&amp;</span>buffer, <span style="color:#f92672">&amp;</span>bytesRead);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    std<span style="color:#f92672">::</span>cout <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>dec <span style="color:#f92672">&lt;&lt;</span> <span style="color:#f92672">*</span>(<span style="color:#66d9ef">int</span><span style="color:#f92672">*</span>)buffer <span style="color:#f92672">&lt;&lt;</span> std<span style="color:#f92672">::</span>endl;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    vm_deallocate(mach_task_self(), buffer, bytesRead);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">uint32_t</span> data_to_write <span style="color:#f92672">=</span> <span style="color:#ae81ff">42</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Write data to the target process&#39;s memory
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mach_vm_write(targetTask, address, data_to_write, <span style="color:#66d9ef">sizeof</span>(data_to_write));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// Clean up and release the task port
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    mach_port_deallocate(mach_task_self(), targetTask);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Sounds about right!
Let&rsquo;s check the output!</p>
<p><img src="/images/output.png" alt="output"></p>
<p>Good info here:</p>
<p><a href="https://github.com/attilathedud/macos_task_for_pid">https://github.com/attilathedud/macos_task_for_pid</a></p>
<p><a href="https://www.spaceflint.com/?p=150">https://www.spaceflint.com/?p=150</a></p>
<p><a href="https://os-tres.net/blog/2010/02/17/mac-os-x-and-task-for-pid-mach-call/">https://os-tres.net/blog/2010/02/17/mac-os-x-and-task-for-pid-mach-call/</a></p>
</div></article>
<footer class="py:24">
    <div class="f:fade-30 f:14 mb:8"></div>
    <div class="f:fade-60 f:12">Theme <a class="f:bold" href="https://github.com/serkodev/holy" _target="_blank">Holy</a></div>
</footer></div>
    </div>
</body>

</html>